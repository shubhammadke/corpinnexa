<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CORPINNEXA</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas & jsPDF for SmartPlan export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ---------- Global light theme ---------- */
    :root{
      --bg: #f6f8ff;
      --card: #ffffff;
      --muted: #5b647a;
      --ink: #0b1020;
      --primary: #2f6bff;
      --success: #0ea879;
      --warning: #b77400;
      --red: #e75151;
      --input-bg: #f4f6ff;
      --border: #d8def2;
      --divider: #e1e7fb;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Roboto,Arial,sans-serif}
    body{background:var(--bg);color:var(--ink);margin:0;padding:0}
    header.top{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--card);border-bottom:1px solid var(--border)}
    h1{font-size:18px;margin:0}
    .toggle{display:flex;gap:10px}
    .toggle button{padding:8px 14px;border-radius:8px;border:1px solid var(--border);cursor:pointer;background:var(--input-bg);font-weight:700}
    .toggle button.active{background:var(--primary);color:white;border-color:var(--primary)}
    main{padding:18px}
    .app-section{display:none}
    .app-section.active{display:block}

    /* ---------- Calculator styles (calced) ---------- */
    .calc-container{max-width:1200px;margin:0 auto}
    .calc-card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);margin-bottom:14px}
    .calc-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .calc-tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:transparent;border:1px solid var(--border);font-weight:600}
    .calc-tab.active{background:var(--primary);color:#fff}
    .calc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .calc-label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    .calc-input, .calc-select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--ink);margin-top:6px;font-size:14px}
    .btn{background:var(--primary);color:#fff;padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;margin-top:10px}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px dashed var(--divider);text-align:left;font-size:14px}
    .resultBox{margin-top:10px;padding:12px;background:var(--input-bg);border-radius:10px;border-left:4px solid var(--primary);font-size:14px;line-height:1.5}
    .small{font-size:13px;color:var(--muted)}
    .divider{height:1px;background:var(--divider);margin:12px 0}
    canvas{max-width:100%;height:300px}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    .risk{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .risk.low{background:#e6f8f0;color:var(--success)}
    .risk.med{background:#fff4e6;color:var(--warning)}
    .risk.high{background:#ffe6ea;color:var(--red)}

    /* ---------- SmartPlan styles (planed) ---------- */
    .plan-container{max-width:1240px;margin:0 auto}
    .plan-layout{display:grid;grid-template-columns:1fr 620px;gap:16px}
    .plan-card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(11,16,32,0.05);border:1px solid var(--border)}
    label{display:block;margin-top:10px;font-weight:700;color:var(--muted);font-size:13px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);margin-top:6px;font-size:14px;background:var(--input-bg);color:var(--ink)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:#f0f4ff;padding:8px 10px;border-radius:10px;font-weight:700;border:1px solid var(--border)}
    .summary-box{margin-top:12px;background:#fbfdff;border-left:4px solid var(--primary);padding:14px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .product-list, .scroll{max-height:260px;overflow:auto;padding:8px;border-radius:10px;border:1px dashed var(--border);background:#fbfdff}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f4f6ff;margin:4px 6px 0 0;font-size:12px;border:1px solid #e6eefc}
    .equity{color:#2563eb;font-weight:800}
    .mf{color:#10b981;font-weight:800}
    .ins{color:#f59e0b;font-weight:800}
    .note{font-size:12.5px;color:var(--muted);margin-top:6px}
    .badge{font-size:11px;font-weight:800;padding:4px 8px;border-radius:8px;background:#f4f7ff;border:1px solid var(--border)}
    .ok{color:var(--success)}
    .warn{color:var(--warning)}
    .bad{color:var(--red)}
    .hint{font-size:12px;color:#4f8cff}
    .quickbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chipbtn{background:#f4f7ff;border:1px solid var(--border);color:var(--ink);border-radius:999px;padding:6px 10px;cursor:pointer;font-size:12px}

    /* small responsive */
    @media (max-width:900px){
      .plan-layout{grid-template-columns:1fr}
      .grid2{grid-template-columns:1fr}
      .calc-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Top header & toggle -->
  <header class="top">
    <h1>ðŸ“Š CORPINNEXA (NEXT-GEN ADVISOR)</h1>
    <div class="toggle">
      <button id="btnCalc" class="active" onclick="showApp('calc')">Investment Calculator</button>
      <button id="btnPlan" onclick="showApp('plan')">SmartPlan Advisor</button>
    </div>
  </header>

  <main>
    <!-- =============== Investment Calculator (calc) =============== -->
    <section id="calc" class="app-section active">
      <div class="calc-container">
        <div class="calc-card">
          <div style="display:flex;align-items:center;gap:12px;">
            <img src="LOGO.jpg" alt="CORPIN Logo" style="height:42px; width:auto; border-radius:6px;">
            <div>
              <div style="font-weight:700;font-size:16px">CORPIN Investment & Securities â€” Investment Calculator</div>
              <div class="small">All-in-one investment calculator (SIP, Lumpsum, FD, PPF, NPS, ULIP, G-Sec, Compare)</div>
            </div>
          </div>

          <div class="calc-tabs" id="calc_tabs"></div>
          <div id="calc_contents"></div>
        </div>
      </div>
    </section>

    <!-- =============== SmartPlan Advisor (plan) =============== -->
    <section id="plan" class="app-section">
       <div class="plan-container">
	<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
  	<img src="LOGO.jpg" alt="CORPIN Logo" style="height:50px; width:auto;">
  	<h1>CORPIN NEXA (Next-gen AI Advisor)</h1>
	</div>

        <div class="plan-layout">

          <!-- Left column (inputs) -->
          <div>
            <div class="plan-card">
              <div style="font-weight:900;margin-bottom:8px">Profile & Protection Inputs</div>
              <div class="small">Edit values and press <b>Generate Plan</b> to refresh recommendations.</div>

              <label for="plan_name">Name</label>
              <input id="plan_name" type="text" value="Sample User">

              <div class="grid2">
                <div>
                  <label for="plan_dob">Date of Birth</label>
                  <input id="plan_dob" type="date" value="1993-08-15">
                </div>
                <div>
                  <label for="plan_gender">Gender</label>
                  <select id="plan_gender"><option value="male" selected>Male</option><option value="female">Female</option></select>
                </div>
              </div>

              <label for="plan_age">Age (auto)</label>
              <input id="plan_age" type="number" readonly>

              <label for="plan_risk">Risk appetite</label>
              <select id="plan_risk"><option>Moderate</option><option>Conservative</option><option>Aggressive</option></select>

              <div class="grid2">
                <div>
                  <label for="plan_salary">Annual Salary (â‚¹)</label>
                  <input id="plan_salary" type="number" value="1200000" min="0" step="1000">
                </div>
                <div>
                  <label for="plan_expenses">Monthly Expenses (â‚¹)</label>
                  <input id="plan_expenses" type="number" value="50000" min="0" step="500">
                </div>
              </div>

              <div class="grid2">
                <div>
                  <label for="plan_familySize">Family size (including you)</label>
                  <input id="plan_familySize" type="number" value="4" min="1">
                </div>
                <div>
                  <label for="plan_emergencyMonths">Emergency fund (months saved)</label>
                  <input id="plan_emergencyMonths" type="number" value="2" min="0">
                </div>
              </div>

              <div class="grid2">
                <div>
                  <label for="plan_currentLife">Existing Life Cover (â‚¹)</label>
                  <input id="plan_currentLife" type="number" value="5000000" min="0" step="50000">
                </div>
                <div>
                  <label for="plan_currentHealth">Existing Health Cover (â‚¹)</label>
                  <input id="plan_currentHealth" type="number" value="500000" min="0" step="10000">
                </div>
              </div>

              <div class="grid2">
                <div>
                  <label for="plan_smoker">Smoker?</label>
                  <select id="plan_smoker"><option value="no" selected>No</option><option value="yes">Yes</option></select>
                </div>
                <div>
                  <label for="plan_coverTerm">Cover Term (years)</label>
                  <input id="plan_coverTerm" type="number" value="30" min="5" max="60">
                </div>
              </div>

              <div style="margin-top:8px;">
                <label for="plan_parents">Include Parents in Health Cover?</label>
                <select id="plan_parents"><option value="no" selected>No</option><option value="yes">Yes</option></select>
              </div>

              <div class="divider"></div>

              <div style="margin-top:8px" class="section-title"><strong>Goals (add your targets)</strong></div>
              <div class="grid2">
                <div>
                  <label for="plan_gName">Goal</label>
                  <input id="plan_gName" placeholder="e.g., Retirement">
                </div>
                <div>
                  <label for="plan_gTarget">Target Amount (â‚¹)</label>
                  <input id="plan_gTarget" type="number" placeholder="e.g., 20000000">
                </div>
              </div>
              <div class="grid2">
                <div>
                  <label for="plan_gYears">Years</label>
                  <input id="plan_gYears" type="number" placeholder="e.g., 25">
                </div>
                <div>
                  <label for="plan_gReturn">Expected Return (% p.a.)</label>
                  <input id="plan_gReturn" type="number" placeholder="e.g., 12">
                </div>
              </div>
              <div style="margin-top:10px">
                <button class="btn" id="plan_addGoalBtn">Add Goal</button>
                <span class="small">You can add multiple goals.</span>
              </div>

              <div style="margin-top:14px;display:flex;gap:8px;">
                <button class="btn" id="plan_generateBtn">Generate Plan</button>
                <button class="btn ghost" id="plan_resetBtn">Reset</button>
              </div>
            </div>

            <div class="plan-card" style="margin-top:12px;">
              <div style="font-weight:900;margin-bottom:8px">Quick Chat</div>
              <div class="small">Ask a quick question or click a shortcut.</div>
              <div class="quickbar" id="plan_quickbar"></div>
              <textarea id="plan_chatIn" rows="3" placeholder="Type here..."></textarea>
              <div style="margin-top:8px;">
                <button class="btn" id="plan_chatBtn">Send</button>
              </div>
              <div id="plan_chatOut" class="scroll" style="margin-top:8px; min-height:60px"></div>
            </div>
          </div>

          <!-- Right column (outputs) -->
          <div>
            <div class="plan-card" id="plan_planPanel">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div><strong>Personalised Plan & Visuals</strong></div>
                <div><button class="btn" id="plan_exportPdfBtn">ðŸ“„ Export PDF</button></div>
              </div>

              <div id="plan_summary" class="summary-box"><div class="small">No plan yet â€” press Generate Plan.</div></div>

              <div class="kpi" id="plan_kpiBar" style="margin-top:8px; display:none;"></div>

              <div style="display:flex;gap:12px;margin-top:12px;">
                <div class="plan-card" style="flex:1">
                  <div style="font-weight:800;margin-bottom:8px;">Asset Allocation (Top 4)</div>
                  <canvas id="plan_assetPie"></canvas>
                  <div class="note">Tip: Allocation adjusts with risk profile.</div>
                </div>
              </div>

              <div class="plan-card" style="margin-top:12px;">
                <div style="font-weight:800" class="equity">Product Shortlist â€” <span class="equity">Equities</span> & <span class="mf">Mutual Funds</span></div>
                <div class="small" style="margin-top:6px">Equity picks, IAP options, and risk-based suggestions.</div>
                <div id="plan_productShortlist" class="product-list" style="margin-top:8px"></div>
              </div>

              <div class="plan-card" style="margin-top:12px;">
                <div style="font-weight:800" class="mf">Recommended Mutual Funds (Category-wise)</div>
                <div class="small" style="margin-top:6px">Suggested funds across Large Cap, Flexi Cap, Mid/Small, Hybrid, Debt.</div>
                <div id="plan_mfShortlist" class="product-list" style="margin-top:8px"></div>
              </div>

              <div class="plan-card" style="margin-top:12px;">
                <div style="font-weight:800">Premium Estimates</div>
                <div id="plan_premiumBox" class="small" style="margin-top:8px">â€”</div>
              </div>

              <div class="plan-card" style="margin-top:12px;">
                <div style="font-weight:800">Top Insurance Picks</div>
                <div id="plan_insuranceShortlist" class="product-list" style="margin-top:8px"></div>
              </div>

              <div class="plan-card" style="margin-top:12px;">
                <div style="font-weight:800">Protection Gaps</div>
                <div id="plan_gaps" class="small" style="margin-top:8px">â€”</div>
              </div>

              <div class="plan-card" style="margin-top:12px;">
                <div style="font-weight:800">Goals & Suggested SIPs</div>
                <div id="plan_goalsOutput" style="margin-top:8px"></div>
              </div>

              <div class="plan-card" style="margin-top:12px;">
                <div style="font-weight:800">Gold & MLD Ideas</div>
                <div id="plan_goldIdeas" class="small" style="margin-top:8px"></div>
              </div>
            </div>
          </div>

        </div> <!-- end layout -->
      </div> <!-- end plan container -->
    </section>
  </main>

  <script>
  /* ------------------- App switcher ------------------- */
  function showApp(id){
    document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('btnCalc').classList.toggle('active', id === 'calc');
    document.getElementById('btnPlan').classList.toggle('active', id === 'plan');
  }

  /* ------------------- Calculator App (scoped) ------------------- */
  (function initCalculatorApp(){
    // We'll render tabs dynamically into #calc_tabs and #calc_contents
    const tabs = [
      {id:'summary', label:'Summary'},
      {id:'sip', label:'SIP'},
      {id:'lumpsum', label:'Lumpsum'},
      {id:'fd', label:'FD'},
      {id:'ppf', label:'PPF'},
      {id:'nps', label:'NPS'},
      {id:'ulip', label:'ULIP'},
      {id:'gsec', label:'G-Sec / Gilt'},
      {id:'compare', label:'Asset Compare'}
    ];

    const calcRoot = document.getElementById('calc');
    const tabsEl = calcRoot.querySelector('#calc_tabs');
    const contents = calcRoot.querySelector('#calc_contents');
    const compareBag = []; // local compare bag
    const charts = {}; // keep Chart instances

    // utilities
    const fmtINR = v => 'â‚¹' + Math.round(v).toLocaleString('en-IN');
    const yrToMon = r => Math.pow(1+r, 1/12) - 1;
    function fvLump(P,R,yrs){ return P * Math.pow(1+R, yrs); }
    function fvSIP(m,R,yrs){ const i = yrToMon(R); const n = Math.round(yrs*12); if(i===0) return m*n; return m * ((Math.pow(1+i,n)-1)/i) * (1+i); }
    function safeDestroyChart(key){ if(charts[key] && typeof charts[key].destroy === 'function'){ charts[key].destroy(); charts[key] = null; } }
    function barChart(canvasId, labels, values){
      const canvas = calcRoot.querySelector('#' + canvasId);
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      safeDestroyChart(canvasId);
      charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label:'Amount', data: values, backgroundColor: ['rgba(47,107,255,0.85)','rgba(245,158,11,0.75)','rgba(231,81,81,0.75)','rgba(14,168,121,0.85)'] }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: { y: { beginAtZero:true, ticks: { callback: v => 'â‚¹' + v.toLocaleString('en-IN')} } }
        }
      });
    }

    function addToCompare(name, contribution, gains, tax){
      const net = contribution + gains - tax;
      compareBag.push({ name, contribution, gains, tax, net });
      alert(name + ' added to Compare.');
    }

    // render tabs
    function initTabs(){
      tabsEl.innerHTML = '';
      tabs.forEach((t,i) => {
        const b = document.createElement('button');
        b.className = 'calc-tab' + (i===0 ? ' active' : '');
        b.textContent = t.label;
        b.dataset.id = t.id;
        b.addEventListener('click', ()=> {
          calcRoot.querySelectorAll('.calc-tab').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          renderTab(t.id);
        });
        tabsEl.appendChild(b);
      });
    }

    function renderTab(id){
      contents.innerHTML = '';
      if(id==='summary') renderSummary();
      else if(id==='sip') renderSIP();
      else if(id==='lumpsum') renderLumpsum();
      else if(id==='fd') renderFD();
      else if(id==='ppf') renderPPF();
      else if(id==='nps') renderNPS();
      else if(id==='ulip') renderULIP();
      else if(id==='gsec') renderGSec();
      else if(id==='compare') renderCompare();
    }

    /* ---------------- SUMMARY ---------------- */
    function renderSummary(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>Unified Input â€” Calculate All Assets</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Lumpsum Invested (â‚¹)</label>
              <input id="calc_sum_amt" class="calc-input" type="number" value="1000000" />
              <label class="calc-label">Years</label>
              <input id="calc_sum_years" class="calc-input" type="number" value="5" />
              <label class="calc-label">Equity Return % (annual)</label>
              <input id="calc_sum_equity" class="calc-input" type="number" value="12" />
              <label class="calc-label">FD Return % (annual)</label>
              <input id="calc_sum_fd" class="calc-input" type="number" value="7" />
              <label class="calc-label">PPF Return % (annual)</label>
              <input id="calc_sum_ppf" class="calc-input" type="number" value="7.1" />
              <label class="calc-label">NPS Return % (annual)</label>
              <input id="calc_sum_nps" class="calc-input" type="number" value="8" />
              <label class="calc-label">ULIP Return % (annual)</label>
              <input id="calc_sum_ulip" class="calc-input" type="number" value="8" />
              <label class="calc-label">G-Sec Return % (annual)</label>
              <input id="calc_sum_gsec" class="calc-input" type="number" value="7" />
              <label class="calc-label">Tax slab (%) (for FD / coupons / slabs)</label>
              <input id="calc_sum_slab" class="calc-input" type="number" value="30" />
              <div class="row" style="margin-top:8px">
                <button class="btn" id="calc_sum_calc">Calculate All</button>
                <button class="btn ghost" id="calc_sum_add_all">Add All to Compare</button>
              </div>
            </div>
            <div>
              <canvas id="calc_sum_chart"></canvas>
              <table id="calc_sum_tbl">
                <thead><tr><th>Asset</th><th>Pre-Tax</th><th>Tax</th><th>Post-Tax</th><th>Risk</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      `;

      const sumCalcBtn = contents.querySelector('#calc_sum_calc');
      const sumAddBtn = contents.querySelector('#calc_sum_add_all');

      sumCalcBtn.addEventListener('click', ()=> {
        const amt = +contents.querySelector('#calc_sum_amt').value || 0;
        const yrs = +contents.querySelector('#calc_sum_years').value || 0;
        const eqR = (+contents.querySelector('#calc_sum_equity').value || 0)/100;
        const fdR = (+contents.querySelector('#calc_sum_fd').value || 0)/100;
        const ppfR = (+contents.querySelector('#calc_sum_ppf').value || 0)/100;
        const npsR = (+contents.querySelector('#calc_sum_nps').value || 0)/100;
        const ulipR = (+contents.querySelector('#calc_sum_ulip').value || 0)/100;
        const gsecR = (+contents.querySelector('#calc_sum_gsec').value || 0)/100;
        const slab = (+contents.querySelector('#calc_sum_slab').value || 0)/100;

        const rows = [];

        // Equity Lumpsum
        const eq_fv = fvLump(amt, eqR, yrs);
        const eq_gains = Math.max(0, eq_fv - amt);
        const eq_tax = eq_gains * 0.125; // LTCG assumed
        rows.push({name:'Equity (Lumpsum)', pre:eq_fv, tax:eq_tax, post:eq_fv - eq_tax, risk:'high', contrib:amt, gains:eq_gains});

        // SIP (approx: same total amount split monthly)
        const monthly = amt/ (yrs*12) || 0;
        const sip_fv = fvSIP(monthly, eqR, yrs);
        const sip_contrib = monthly * 12 * yrs;
        const sip_gains = Math.max(0, sip_fv - sip_contrib);
        const sip_tax = sip_gains * 0.125;
        rows.push({name:'SIP (equivalent)', pre:sip_fv, tax:sip_tax, post:sip_fv - sip_tax, risk:'high', contrib:sip_contrib, gains:sip_gains});

        // FD
        const fd_fv = fvLump(amt, fdR, yrs);
        const fd_gains = Math.max(0, fd_fv - amt);
        const fd_tax = fd_gains * slab;
        rows.push({name:'FD', pre:fd_fv, tax:fd_tax, post:fd_fv - fd_tax, risk:'low', contrib:amt, gains:fd_gains});

        // PPF (treat lumpsum as yearly deposit)
        let ppf_fv=0, ppf_contrib=0;
        for(let i=0;i<yrs;i++){ ppf_fv = (ppf_fv + amt) * (1+ppfR); ppf_contrib += amt; }
        const ppf_gains = Math.max(0, ppf_fv - ppf_contrib);
        rows.push({name:'PPF (yearly)', pre:ppf_fv, tax:0, post:ppf_fv, risk:'low', contrib:ppf_contrib, gains:ppf_gains});

        // NPS (treat lumpsum as monthly contribution)
        const nps_monthly = amt / (yrs * 12) || 0;
        const nps_fv = fvSIP(nps_monthly, npsR, yrs);
        const nps_contrib = nps_monthly * 12 * yrs;
        const nps_tax = 0.40 * nps_fv * slab; // approx
        const nps_post = 0.60 * nps_fv + (0.40 * nps_fv - nps_tax);
        rows.push({name:'NPS', pre:nps_fv, tax:nps_tax, post:nps_post, risk:'med', contrib:nps_contrib, gains: nps_fv - nps_contrib});

        // ULIP
        let ulip_fv=0, ulip_contrib=0;
        for(let i=0;i<yrs;i++){ ulip_fv = (ulip_fv + amt) * (1 + ulipR); ulip_contrib += amt; }
        const ulip_gains = Math.max(0, ulip_fv - ulip_contrib);
        const ulip_tax = ulip_gains * 0.125;
        rows.push({name:'ULIP (yearly)', pre:ulip_fv, tax:ulip_tax, post:ulip_fv - ulip_tax, risk:'med', contrib:ulip_contrib, gains:ulip_gains});

        // G-Sec
        const g_fv = fvLump(amt, gsecR, yrs);
        const g_gains = Math.max(0, g_fv - amt);
        const g_tax = g_gains * slab;
        rows.push({name:'G-Sec (direct/gilt)', pre:g_fv, tax:g_tax, post:g_fv - g_tax, risk:'med', contrib:amt, gains:g_gains});

        const tbody = contents.querySelector('#calc_sum_tbl tbody');
        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.name}</td>
                          <td>${fmtINR(r.pre)}</td>
                          <td>${fmtINR(r.tax)}</td>
                          <td>${fmtINR(r.post)}</td>
                          <td><span class="risk ${r.risk}">${r.risk.toUpperCase()}</span></td>`;
          tbody.appendChild(tr);
        });

        barChart('calc_sum_chart', rows.map(r=>r.name), rows.map(r=>Math.round(r.post)));
        window._calc_lastSummary = rows;
      });

      sumAddBtn.addEventListener('click', ()=> {
        const rows = window._calc_lastSummary;
        if(!rows || !rows.length) { alert('Run Calculate All first'); return; }
        rows.forEach(r => { addToCompare(r.name, r.contrib || r.contribution || (r.pre - r.post), r.gains, r.tax); });
        alert('All summary rows added to Compare.');
      });
    }

    /* ---------------- SIP ---------------- */
    function renderSIP(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>SIP â€” Equity Mutual Fund</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Monthly contribution (â‚¹)</label><input id="calc_sip_m" class="calc-input" type="number" value="20000" />
              <label class="calc-label">Years</label><input id="calc_sip_y" class="calc-input" type="number" value="10" />
              <label class="calc-label">Expected return (% p.a.)</label><input id="calc_sip_r" class="calc-input" type="number" value="12" />
              <label class="calc-label">Holding is â‰¥ 1 year?</label>
              <select id="calc_sip_long" class="calc-select"><option value="1" selected>Yes (LTCG 12.5%)</option><option value="0">No (STCG 20%)</option></select>
              <div class="row"><button class="btn" id="calc_sip_calc">Calculate</button><button class="btn ghost" id="calc_sip_add">Add to Compare</button></div>
            </div>
            <div>
              <div id="calc_sip_out" class="resultBox">Result will appear here.</div>
              <canvas id="calc_sip_chart"></canvas>
            </div>
          </div>
        </div>
      `;
      let last = null;
      contents.querySelector('#calc_sip_calc').addEventListener('click', ()=> {
        const m = +contents.querySelector('#calc_sip_m').value || 0;
        const y = +contents.querySelector('#calc_sip_y').value || 0;
        const r = (+contents.querySelector('#calc_sip_r').value || 0)/100;
        const isLong = contents.querySelector('#calc_sip_long').value==='1';
        const fv = fvSIP(m, r, y);
        const contrib = m * 12 * y;
        const gains = Math.max(0, fv - contrib);
        const rate = isLong ? 0.125 : 0.20;
        const tax = gains * rate;
        const net = fv - tax;
        last = {contrib, gains, tax, net};
        contents.querySelector('#calc_sip_out').innerHTML = `
          Future Value: <b>${fmtINR(fv)}</b><br>
          Total Contributed: ${fmtINR(contrib)}<br>
          Gains: ${fmtINR(gains)}<br>
          Tax @ ${isLong ? '12.5%' : '20%'} on gains: <b>${fmtINR(tax)}</b><br>
          <span style="color:var(--success)"><b>Net after tax:</b> ${fmtINR(net)}</span>`;
        barChart('calc_sip_chart', ['Contribution','Gains','Tax','Net'], [contrib, gains, tax, net]);
      });
      contents.querySelector('#calc_sip_add').addEventListener('click', ()=> {
        if(!last) return alert('Run Calculate first');
        addToCompare('SIP', last.contrib, last.gains, last.tax);
      });
    }

    /* ---------------- Lumpsum ---------------- */
    function renderLumpsum(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>Lumpsum â€” Equity Mutual Fund</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Amount invested (â‚¹)</label><input id="calc_ls_p" class="calc-input" type="number" value="1000000" />
              <label class="calc-label">Years</label><input id="calc_ls_y" class="calc-input" type="number" value="3" />
              <label class="calc-label">Expected return (% p.a.)</label><input id="calc_ls_r" class="calc-input" type="number" value="10" />
              <label class="calc-label">Holding is â‰¥ 1 year?</label>
              <select id="calc_ls_long" class="calc-select"><option value="1">Yes (LTCG 12.5%)</option><option value="0" selected>No (STCG 20%)</option></select>
              <div class="row"><button class="btn" id="calc_ls_calc">Calculate</button><button class="btn ghost" id="calc_ls_add">Add to Compare</button></div>
            </div>
            <div>
              <div id="calc_ls_out" class="resultBox">Result will appear here.</div>
              <canvas id="calc_ls_chart"></canvas>
            </div>
          </div>
        </div>
      `;
      let last = null;
      contents.querySelector('#calc_ls_calc').addEventListener('click', ()=> {
        const P = +contents.querySelector('#calc_ls_p').value || 0;
        const y = +contents.querySelector('#calc_ls_y').value || 0;
        const r = (+contents.querySelector('#calc_ls_r').value || 0)/100;
        const isLong = contents.querySelector('#calc_ls_long').value==='1';
        const fv = fvLump(P, r, y);
        const gains = Math.max(0, fv - P);
        const rate = isLong ? 0.125 : 0.20;
        const tax = gains * rate;
        const net = fv - tax;
        last = {contrib:P, gains, tax, net};
        contents.querySelector('#calc_ls_out').innerHTML = `
          Future Value: <b>${fmtINR(fv)}</b><br>
          Principal: ${fmtINR(P)}<br>
          Gains: ${fmtINR(gains)}<br>
          Tax @ ${isLong ? '12.5%' : '20%'} on gains: <b>${fmtINR(tax)}</b><br>
          <span style="color:var(--success)"><b>Net after tax:</b> ${fmtINR(net)}</span>`;
        barChart('calc_ls_chart', ['Contribution','Gains','Tax','Net'], [P, gains, tax, net]);
      });
      contents.querySelector('#calc_ls_add').addEventListener('click', ()=> {
        if(!last) return alert('Run Calculate first');
        addToCompare('Lumpsum', last.contrib, last.gains, last.tax);
      });
    }

    /* ---------------- FD ---------------- */
    function renderFD(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>Fixed Deposit (FD)</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Principal (â‚¹)</label><input id="calc_fd_p" class="calc-input" type="number" value="1000000" />
              <label class="calc-label">Years</label><input id="calc_fd_y" class="calc-input" type="number" value="1" />
              <label class="calc-label">Interest rate (% p.a.)</label><input id="calc_fd_r" class="calc-input" type="number" value="7" />
              <label class="calc-label">Tax slab (%)</label><input id="calc_fd_slab" class="calc-input" type="number" value="30" />
              <div class="row"><button class="btn" id="calc_fd_calc">Calculate</button><button class="btn ghost" id="calc_fd_add">Add to Compare</button></div>
            </div>
            <div>
              <div id="calc_fd_out" class="resultBox">Result will appear here.</div>
              <canvas id="calc_fd_chart"></canvas>
            </div>
          </div>
        </div>
      `;
      let last = null;
      contents.querySelector('#calc_fd_calc').addEventListener('click', ()=> {
        const P = +contents.querySelector('#calc_fd_p').value || 0;
        const y = +contents.querySelector('#calc_fd_y').value || 0;
        const r = (+contents.querySelector('#calc_fd_r').value || 0)/100;
        const slab = (+contents.querySelector('#calc_fd_slab').value || 0)/100;
        const fv = fvLump(P, r, y);
        const interest = Math.max(0, fv - P);
        const tax = interest * slab;
        const net = fv - tax;
        last = {contrib:P, gains:interest, tax, net};
        contents.querySelector('#calc_fd_out').innerHTML = `
          Maturity Value: <b>${fmtINR(fv)}</b><br>
          Interest Earned: ${fmtINR(interest)}<br>
          Tax on interest (@${(slab*100).toFixed(0)}%): <b>${fmtINR(tax)}</b><br>
          <span style="color:var(--success)"><b>Net after tax:</b> ${fmtINR(net)}</span>`;
        barChart('calc_fd_chart', ['Contribution','Gains','Tax','Net'], [P, interest, tax, net]);
      });
      contents.querySelector('#calc_fd_add').addEventListener('click', ()=> {
        if(!last) return alert('Run Calculate first');
        addToCompare('FD', last.contrib, last.gains, last.tax);
      });
    }

    /* ---------------- PPF ---------------- */
    function renderPPF(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>PPF</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Yearly contribution (â‚¹)</label><input id="calc_ppf_c" class="calc-input" type="number" value="150000" />
              <label class="calc-label">Years</label><input id="calc_ppf_y" class="calc-input" type="number" value="15" />
              <label class="calc-label">Interest rate (% p.a.)</label><input id="calc_ppf_r" class="calc-input" type="number" value="7.1" />
              <div class="row"><button class="btn" id="calc_ppf_calc">Calculate</button><button class="btn ghost" id="calc_ppf_add">Add to Compare</button></div>
            </div>
            <div>
              <div id="calc_ppf_out" class="resultBox">Result will appear here.</div>
              <canvas id="calc_ppf_chart"></canvas>
            </div>
          </div>
        </div>
      `;
      let last = null;
      contents.querySelector('#calc_ppf_calc').addEventListener('click', ()=> {
        const c = +contents.querySelector('#calc_ppf_c').value || 0;
        const yrs = +contents.querySelector('#calc_ppf_y').value || 0;
        const r = (+contents.querySelector('#calc_ppf_r').value || 0)/100;
        let fv = 0, contrib = 0;
        for(let i=0;i<yrs;i++){ fv = (fv + c) * (1 + r); contrib += c; }
        const gains = Math.max(0, fv - contrib);
        const tax = 0;
        last = {contrib, gains, tax, net: fv};
        contents.querySelector('#calc_ppf_out').innerHTML = `
          Maturity Value: <b>${fmtINR(fv)}</b><br>
          Total Contributions: ${fmtINR(contrib)}<br>
          Gains: ${fmtINR(gains)}<br>
          Tax: <b>${fmtINR(tax)}</b><br>
          <span style="color:var(--success)"><b>Net after tax:</b> ${fmtINR(fv)}</span>`;
        barChart('calc_ppf_chart', ['Contribution','Gains','Tax','Net'], [contrib, gains, tax, fv]);
      });
      contents.querySelector('#calc_ppf_add').addEventListener('click', ()=> {
        if(!last) return alert('Run Calculate first');
        addToCompare('PPF', last.contrib, last.gains, last.tax);
      });
    }

    /* ---------------- NPS ---------------- */
    function renderNPS(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>NPS</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Monthly contribution (â‚¹)</label><input id="calc_nps_m" class="calc-input" type="number" value="5000" />
              <label class="calc-label">Years</label><input id="calc_nps_y" class="calc-input" type="number" value="25" />
              <label class="calc-label">Expected return (% p.a.)</label><input id="calc_nps_r" class="calc-input" type="number" value="8" />
              <label class="calc-label">Tax slab (%)</label><input id="calc_nps_slab" class="calc-input" type="number" value="30" />
              <div class="row"><button class="btn" id="calc_nps_calc">Calculate</button><button class="btn ghost" id="calc_nps_add">Add to Compare</button></div>
            </div>
            <div>
              <div id="calc_nps_out" class="resultBox">Result will appear here.</div>
              <canvas id="calc_nps_chart"></canvas>
            </div>
          </div>
        </div>
      `;
      let last = null;
      contents.querySelector('#calc_nps_calc').addEventListener('click', ()=> {
        const m = +contents.querySelector('#calc_nps_m').value || 0;
        const yrs = +contents.querySelector('#calc_nps_y').value || 0;
        const r = (+contents.querySelector('#calc_nps_r').value || 0)/100;
        const slab = (+contents.querySelector('#calc_nps_slab').value || 0)/100;
        const fv = fvSIP(m, r, yrs);
        const contrib = m * 12 * yrs;
        const lump = 0.60 * fv; // tax-free
        const ann = 0.40 * fv;
        const tax = ann * slab;
        const net = lump + (ann - tax);
        const gains = Math.max(0, fv - contrib);
        last = {contrib, gains, tax, net};
        contents.querySelector('#calc_nps_out').innerHTML = `
          Corpus (FV): <b>${fmtINR(fv)}</b><br>
          60% Lumpsum (tax-free): ${fmtINR(lump)}<br>
          40% Annuity (taxable): ${fmtINR(ann)} | Est. Tax: ${fmtINR(tax)}<br>
          <b>Total Net after tax:</b> <span style="color:var(--success)">${fmtINR(net)}</span><br>
          Contributions: ${fmtINR(contrib)} | Gains: ${fmtINR(gains)}`;
        barChart('calc_nps_chart', ['Contribution','Gains','Tax','Net'], [contrib, gains, tax, net]);
      });
      contents.querySelector('#calc_nps_add').addEventListener('click', ()=> {
        if(!last) return alert('Run Calculate first');
        addToCompare('NPS', last.contrib, last.gains, last.tax);
      });
    }

    /* ---------------- ULIP ---------------- */
    function renderULIP(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>ULIP</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Annual premium (â‚¹)</label><input id="calc_ulip_prem" class="calc-input" type="number" value="250000" />
              <label class="calc-label">Years paid</label><input id="calc_ulip_y" class="calc-input" type="number" value="10" />
              <label class="calc-label">Expected return (% p.a.)</label><input id="calc_ulip_r" class="calc-input" type="number" value="8" />
              <label class="calc-label">Is annual premium â‰¤ â‚¹2.5L (exempt)?</label>
              <select id="calc_ulip_exempt" class="calc-select"><option value="1" selected>Yes (exempt)</option><option value="0">No (taxable)</option></select>
              <div class="row"><button class="btn" id="calc_ulip_calc">Calculate</button><button class="btn ghost" id="calc_ulip_add">Add to Compare</button></div>
            </div>
            <div>
              <div id="calc_ulip_out" class="resultBox">Result will appear here.</div>
              <canvas id="calc_ulip_chart"></canvas>
            </div>
          </div>
        </div>
      `;
      let last = null;
      contents.querySelector('#calc_ulip_calc').addEventListener('click', ()=> {
        const prem = +contents.querySelector('#calc_ulip_prem').value || 0;
        const yrs = +contents.querySelector('#calc_ulip_y').value || 0;
        const r = (+contents.querySelector('#calc_ulip_r').value || 0)/100;
        const exempt = contents.querySelector('#calc_ulip_exempt').value === '1';
        let fv = 0, contrib = 0;
        for(let i=0;i<yrs;i++){ fv = (fv + prem) * (1 + r); contrib += prem; }
        const gains = Math.max(0, fv - contrib);
        const tax = exempt ? 0 : gains * 0.125;
        const net = fv - tax;
        last = {contrib, gains, tax, net};
        contents.querySelector('#calc_ulip_out').innerHTML = `
          Maturity Value: <b>${fmtINR(fv)}</b><br>
          Contributions: ${fmtINR(contrib)} | Gains: ${fmtINR(gains)}<br>
          Tax: <b>${fmtINR(tax)}</b> ${exempt ? '(exempt)' : '(12.5% on gains)'}<br>
          <span style="color:var(--success)"><b>Net after tax:</b> ${fmtINR(net)}</span>`;
        barChart('calc_ulip_chart', ['Contribution','Gains','Tax','Net'], [contrib, gains, tax, net]);
      });
      contents.querySelector('#calc_ulip_add').addEventListener('click', ()=> {
        if(!last) return alert('Run Calculate first');
        addToCompare('ULIP', last.contrib, last.gains, last.tax);
      });
    }

    /* ---------------- G-Sec/Gilt ---------------- */
    function renderGSec(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>G-Sec & Gilt</h3>
          <div class="calc-grid">
            <div>
              <label class="calc-label">Mode</label>
              <select id="calc_g_mode" class="calc-select"><option value="gilt">Gilt Fund (NAV redemption)</option><option value="direct">Direct G-Sec (coupon)</option></select>

              <div id="calc_g_gilt_inputs" style="margin-top:8px;">
                <label class="calc-label">Lumpsum Invested (â‚¹)</label><input id="calc_g_lump" class="calc-input" type="number" value="1000000" />
                <label class="calc-label">Original NAV (â‚¹)</label><input id="calc_g_orig" class="calc-input" type="number" value="10" />
                <label class="calc-label">Current NAV (â‚¹)</label><input id="calc_g_curr" class="calc-input" type="number" value="10.7" />
                <label class="calc-label">Withdrawal amount (â‚¹)</label><input id="calc_g_withdraw" class="calc-input" type="number" value="70000" />
                <label class="calc-label">Tax slab on profit</label>
                <select id="calc_g_slab" class="calc-select"><option value="0.05">5%</option><option value="0.10">10%</option><option value="0.20">20%</option><option value="0.30" selected>30%</option></select>
              </div>

              <div id="calc_g_direct_inputs" style="display:none;margin-top:8px;">
                <label class="calc-label">Face value invested (â‚¹)</label><input id="calc_g_face" class="calc-input" type="number" value="1000000" />
                <label class="calc-label">Coupon yield (% p.a.)</label><input id="calc_g_coupon" class="calc-input" type="number" value="7" />
                <label class="calc-label">Years held</label><input id="calc_g_holdyrs" class="calc-input" type="number" value="5" />
                <label class="calc-label">Sale price (â‚¹) (0 to skip)</label><input id="calc_g_sale" class="calc-input" type="number" value="0" />
                <label class="calc-label">Tax slab (%)</label><input id="calc_g_slab2" class="calc-input" type="number" value="30" />
                <label><input id="calc_g_apply12p5" type="checkbox" /> Apply 12.5% LTCG if >3y</label>
              </div>

              <div class="row"><button class="btn" id="calc_g_calc">Calculate</button><button class="btn ghost" id="calc_g_add">Add to Compare</button></div>
            </div>

            <div>
              <div id="calc_g_out" class="resultBox">Result will appear here.</div>
              <canvas id="calc_g_chart"></canvas>
            </div>
          </div>
        </div>
      `;

      const modeEl = contents.querySelector('#calc_g_mode');
      const g_gilt = contents.querySelector('#calc_g_gilt_inputs');
      const g_direct = contents.querySelector('#calc_g_direct_inputs');
      modeEl.addEventListener('change', ()=> {
        const v = modeEl.value;
        g_gilt.style.display = v === 'gilt' ? 'block' : 'none';
        g_direct.style.display = v === 'direct' ? 'block' : 'none';
      });

      let last = null;
      contents.querySelector('#calc_g_calc').addEventListener('click', ()=> {
        const mode = contents.querySelector('#calc_g_mode').value;
        if(mode === 'gilt'){
          const lump = +contents.querySelector('#calc_g_lump').value || 0;
          const orig = +contents.querySelector('#calc_g_orig').value || 0;
          const curr = +contents.querySelector('#calc_g_curr').value || 0;
          const withdrawal = +contents.querySelector('#calc_g_withdraw').value || 0;
          const slab = +contents.querySelector('#calc_g_slab').value || 0.30;

          const totalUnits = (orig > 0) ? (lump / orig) : 0;
          let unitsRedeemed = (curr > 0) ? (withdrawal / curr) : 0;
          if(unitsRedeemed > totalUnits) unitsRedeemed = totalUnits;

          const buyingCost = unitsRedeemed * orig;
          const profit = Math.max(0, (withdrawal) - buyingCost);
          const tax = profit * slab;
          const net = withdrawal - tax;

          last = { contrib: buyingCost, gains: profit, tax: tax, net: net };

          contents.querySelector('#calc_g_out').innerHTML = `
            <b>Gilt Fund (NAV redemption)</b><br>
            Total units owned: <b>${totalUnits.toFixed(2)}</b><br>
            Units being redeemed: <b>${unitsRedeemed.toFixed(2)}</b><br>
            Buying cost of redeemed units: ${fmtINR(buyingCost)}<br>
            Withdrawal (gross): ${fmtINR(withdrawal)}<br>
            <b>Profit portion (taxable):</b> ${fmtINR(profit)}<br>
            Tax (@${(slab*100).toFixed(0)}%): <b>${fmtINR(tax)}</b><br>
            <span style="color:var(--success)"><b>Net in hand:</b> ${fmtINR(net)}</span>
          `;
          barChart('calc_g_chart', ['Withdrawal','Tax','Net'], [withdrawal, tax, net]);
        } else {
          const face = +contents.querySelector('#calc_g_face').value || 0;
          const couponPct = (+contents.querySelector('#calc_g_coupon').value || 0) / 100;
          const yrs = +contents.querySelector('#calc_g_holdyrs').value || 0;
          const sale = +contents.querySelector('#calc_g_sale').value || 0;
          const slab = (+contents.querySelector('#calc_g_slab2').value || 0) / 100;
          const apply12 = contents.querySelector('#calc_g_apply12p5').checked;

          const totalCoupon = face * couponPct * yrs;
          const taxOnCoupon = totalCoupon * slab;

          let saleGain = 0;
          let taxOnSale = 0;
          if(sale > 0){
            saleGain = Math.max(0, sale - face);
            if(yrs > 3 && apply12) taxOnSale = saleGain * 0.125;
            else taxOnSale = saleGain * slab;
          }

          const totalTax = taxOnCoupon + taxOnSale;
          const gains = totalCoupon + saleGain;
          const net = face + gains - totalTax;

          last = { contrib: face, gains: gains, tax: totalTax, net: net };

          contents.querySelector('#calc_g_out').innerHTML = `
            <b>Direct G-Sec (coupon)</b><br>
            Coupon total (approx): ${fmtINR(totalCoupon)}<br>
            Tax on coupon (@${(slab*100).toFixed(0)}%): ${fmtINR(taxOnCoupon)}<br>
            ${sale>0 ? `Sale proceeds: ${fmtINR(sale)} | Sale gain: ${fmtINR(saleGain)} | Tax on sale: ${fmtINR(taxOnSale)}<br>` : ''}
            <b>Total Tax:</b> ${fmtINR(totalTax)}<br>
            <span style="color:var(--success)"><b>Approx Net (principal + net gains):</b> ${fmtINR(net)}</span>
          `;
          barChart('calc_g_chart', ['Contribution','Gains','Tax','Net'], [face, gains, totalTax, net]);
        }
      });

      contents.querySelector('#calc_g_add').addEventListener('click', ()=> {
        if(!last) return alert('Run Calculate first');
        addToCompare('G-Sec/Gilt', last.contrib || 0, last.gains || 0, last.tax || 0);
      });
    }

    /* ---------------- Compare ---------------- */
    function renderCompare(){
      contents.innerHTML = `
        <div class="calc-card">
          <h3>Asset Compare</h3>
          <div class="small">Add individual results (using 'Add to Compare' in each tab) or add all from Summary.</div>
          <div class="row" style="margin-top:10px"><button class="btn" id="calc_cmp_refresh">Refresh Chart</button><button class="btn ghost" id="calc_cmp_clear">Clear</button></div>
          <div class="divider"></div>
          <canvas id="calc_cmp_chart"></canvas>
          <table id="calc_cmp_tbl"><thead><tr><th>Asset</th><th>Contribution</th><th>Gains</th><th>Tax</th><th>Net</th></tr></thead><tbody></tbody></table>
        </div>
      `;
      const redraw = ()=> {
        const labels = compareBag.map(x=>x.name);
        const contribs = compareBag.map(x=>x.contribution || x.contrib || 0);
        const gains = compareBag.map(x=>x.gains || 0);
        const tax = compareBag.map(x=>x.tax || 0);
        const net = compareBag.map(x=>x.net || ((x.contribution||x.contrib||0) + (x.gains||0) - (x.tax||0)));

        const tbody = contents.querySelector('#calc_cmp_tbl tbody');
        tbody.innerHTML = '';
        compareBag.forEach(x=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${x.name}</td><td>${fmtINR(x.contribution || x.contrib || 0)}</td><td>${fmtINR(x.gains || 0)}</td><td>${fmtINR(x.tax || 0)}</td><td>${fmtINR(x.net || ((x.contribution||x.contrib||0) + (x.gains||0) - (x.tax||0)))}</td>`;
          tbody.appendChild(tr);
        });

        // grouped bar
        const canvas = contents.querySelector('#calc_cmp_chart');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if(charts['calc_cmp_chart']) charts['calc_cmp_chart'].destroy();
        charts['calc_cmp_chart'] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label:'Contribution', data: contribs },
              { label:'Gains', data: gains },
              { label:'Tax', data: tax },
              { label:'Net', data: net }
            ]
          },
          options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ callback: v => 'â‚¹' + v.toLocaleString('en-IN') } } } }
        });
      };

      contents.querySelector('#calc_cmp_refresh').addEventListener('click', redraw);
      contents.querySelector('#calc_cmp_clear').addEventListener('click', ()=> { compareBag.length = 0; redraw(); });
      // initial draw
      redraw();
    }

    initTabs();
    renderTab('summary'); // default
  })(); // end calculator IIFE

  /* ------------------- SmartPlan App (scoped) ------------------- */
  (function initSmartPlanApp(){
    // State & static data
    let finalPlan = null;
    let goals = [];
    const equityProducts = [
      "Reliance Industries","HDFC Bank","Infosys","TCS","ICICI Bank","Kotak Mahindra Bank","Axis Bank",
      "Larsen & Toubro","Bajaj Finance","Maruti Suzuki","ITC","Hindustan Unilever","SBI","Bharti Airtel",
      "Titan Company","Mahindra & Mahindra","Sun Pharma","HCL Tech","Wipro","Power Grid"
    ];

    const sectorTopCompanies = {
      banking:["HDFC Bank","ICICI Bank","SBI","Kotak Bank","Axis Bank"],
      it:["TCS","Infosys","HCL Tech","Wipro","Tech Mahindra"],
      fmcg:["HUL","ITC","Nestle India","Britannia","Dabur"],
      auto:["Maruti Suzuki","Tata Motors","Mahindra & Mahindra","Bajaj Auto","Hero MotoCorp"],
      pharma:["Sun Pharma","Dr. Reddy's","Cipla","Divi's Labs","Apollo Hospitals"],
      energy:["Reliance Industries","NTPC","Power Grid","ONGC","Adani Green"],
      infra:["Larsen & Toubro","Adani Ports","GMR Airports","IRB Infra","DLF"],
      telecom:["Bharti Airtel","Jio Platforms (RIL)","Vodafone Idea"]
    };

    const iapOptions = [
      "Prime â€” starts â‚¹1,00,000",
      "Zodiac â€” starts â‚¹1,50,000",
      "Alpha Bluechip & Alpha Next â€” starts â‚¹2,50,000",
      "NS Industry Champ â€” starts â‚¹5,00,000",
      "Debt Allocation: MLDs â€” starts â‚¹5,00,000"
    ];

    const mfByCategory = {
      "Large Cap": ["Axis Bluechip Fund","SBI Bluechip Fund","HDFC Top 100","ICICI Prudential Bluechip","Mirae Asset Large Cap"],
      "Mid Cap": ["Kotak Emerging Equity","Axis Midcap","HDFC Midcap Opportunities","Nippon India Growth","DSP Midcap"],
      "Small Cap": ["Nippon Small Cap","SBI Small Cap","Axis Small Cap","HDFC Small Cap","Kotak Small Cap"],
      "Flexi Cap": ["Parag Parikh Flexi Cap","Kotak Flexicap","HDFC Flexicap","UTI Flexicap","DSP Flexi Cap"],
      "Hybrid": ["HDFC Balanced Advantage","SBI Equity Hybrid","ICICI Balanced Advantage","Mirae Hybrid","UTI Hybrid Equity"],
      "Debt": ["HDFC Corporate Bond","ICICI Corporate Bond","SBI Magnum Debt","Axis Corporate Debt","Aditya Birla Gilt"]
    };

    // helpers
    const fmtINR = n => "â‚¹" + (Number(n)||0).toLocaleString("en-IN",{maximumFractionDigits:0});
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    // DOM shortcuts
    const root = document.getElementById('plan');
    const get = sel => root.querySelector(sel);

    // Age auto-calc
    function computeAgeFromDOB(dobVal){
      if(!dobVal) return '';
      const dob = new Date(dobVal);
      if(isNaN(dob)) return '';
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if(m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
      return age;
    }
    // attach DOB listener
    const dobEl = get('#plan_dob');
    const ageEl = get('#plan_age');
    dobEl.addEventListener('change', ()=>{
      const age = computeAgeFromDOB(dobEl.value);
      ageEl.value = age !== '' ? age : '';
    });
    // ensure initial fill
    ageEl.value = computeAgeFromDOB(dobEl.value);

    // addGoal button
    get('#plan_addGoalBtn').addEventListener('click', ()=>{
      const name = (get('#plan_gName').value||"Goal").trim();
      const target = Number(get('#plan_gTarget').value||0);
      const years = Number(get('#plan_gYears').value||0);
      const ret = Number(get('#plan_gReturn').value||0);
      if(!target || !years || !ret){ alert("Enter target, years, return %"); return; }
      goals.push({name, target, years, returnPct:ret});
      get('#plan_gName').value=""; get('#plan_gTarget').value=""; get('#plan_gYears').value=""; get('#plan_gReturn').value="";
      if(finalPlan) renderGoals();
      alert('Goal added');
    });

    // generate, reset
    get('#plan_generateBtn').addEventListener('click', generateFinalPlan);
    get('#plan_resetBtn').addEventListener('click', ()=>{
      finalPlan = null; goals = [];
      // clear outputs
      get('#plan_summary').innerHTML = '<div class="small">No plan yet â€” press Generate Plan.</div>';
      get('#plan_kpiBar').style.display = 'none';
      get('#plan_productShortlist').innerHTML = '';
      get('#plan_mfShortlist').innerHTML = '';
      get('#plan_premiumBox').innerHTML = 'â€”';
      get('#plan_insuranceShortlist').innerHTML = '';
      get('#plan_gaps').innerHTML = 'â€”';
      get('#plan_goalsOutput').innerHTML = '';
      get('#plan_goldIdeas').innerHTML = '';
      if(window._plan_assetChart){ try{ window._plan_assetChart.destroy(); }catch(e){} window._plan_assetChart = null; }
      alert('Reset done');
    });

    // chat quick buttons
    function quickButton(label, query){
      const b = document.createElement('button'); b.className='chipbtn'; b.textContent = label;
      b.onclick = ()=>{ get('#plan_chatIn').value = query; chatSend(); };
      return b;
    }
    function renderQuickbar(){
      const qb = get('#plan_quickbar'); qb.innerHTML = '';
      const items = [
        ["Approx Premium","approx premium"],
        ["Large Cap funds","large cap funds"],
        ["Mid Cap funds","mid cap funds"],
        ["Small Cap funds","small cap funds"],
        ["Sector funds","sector mutual funds"],
        ["Top Banks","top companies banking"],
        ["Top IT","top companies it"],
        ["Top FMCG","top companies fmcg"],
        ["SIP from salary","sip budget from salary"]
      ];
      items.forEach(([l,q])=> qb.appendChild(quickButton(l,q)));
    }

    // initial data renderers
    function suggestedSipFromSalary(p){
      const monthlyIncome = p.salary/12;
      return Math.round(monthlyIncome * 0.20);
    }

    function renderSummary(){
      const p = finalPlan.profile;
      const sipBudget = suggestedSipFromSalary(p);
      get('#plan_summary').innerHTML = `
        <div style="font-weight:800">${p.name} â€¢ Age ${p.age}</div>
        <div style="text-align:center">Risk: <b>${p.risk}</b><br/>Family: ${p.familySize}</div>
        <div style="text-align:right"><div style="font-size:18px;font-weight:900;color:var(--primary)">${fmtINR(sipBudget)}</div><div class="small">Suggested SIP / month</div></div>
      `;
    }

    function renderKPI(){
      const p = finalPlan.profile;
      const bar = get('#plan_kpiBar'); bar.style.display = 'flex';
      const monthlyIncome = p.salary/12;
      const surplus = Math.max(0, monthlyIncome - p.expenses);
      const sipBudget = suggestedSipFromSalary(p);
      bar.innerHTML = `<div class="chip">Income/mo: <b>${fmtINR(monthlyIncome)}</b></div><div class="chip">Surplus/mo: <b>${fmtINR(surplus)}</b></div><div class="chip">SIP Budget: <b>${fmtINR(sipBudget)}</b></div>`;
    }

    function riskBasedEquities(risk){
      if(risk==="Conservative") return ["ITC","HUL","Power Grid","SBI Life","HDFC Bank","NTPC"];
      if(risk==="Aggressive")   return ["Tata Motors","Adani Ports","Zomato","PB Fintech","Gland Pharma","Tata Elxsi"];
      return ["L&T","ICICI Bank","Infosys","Maruti Suzuki","Bharti Airtel","Sun Pharma"];
    }
    function riskBasedFunds(risk){
      if(risk==="Conservative") return ["Corporate Bond Fund","Banking & PSU Debt","Arbitrage Fund","Balanced Advantage"];
      if(risk==="Aggressive")   return ["Midcap Fund","Small Cap Fund","Flexi Cap","ELSS (Tax)"];
      return ["Large & Midcap","Flexi Cap","Balanced Advantage","ELSS (Tax)"];
    }

    function renderShortlists(){
      const p = finalPlan.profile;
      const eqHtml = `<div><b class="equity">Equity Suggestions (20):</b><br>${equityProducts.map(s=>`<span class="pill equity">${s}</span>`).join(" ")}</div>`;
      const iap = `<div style="margin-top:10px"><b>IAP Options:</b><br>${iapOptions.map(s=>`<div>â€¢ ${s}</div>`).join("")}</div>`;
      const riskEq = `<div style="margin-top:10px"><b class="equity">Risk-based Equities:</b><br>${riskBasedEquities(p.risk).map(s=>`<span class="pill equity">${s}</span>`).join(" ")}</div>`;
      const riskMf = `<div style="margin-top:10px"><b class="mf">Risk-based Funds:</b><br>${riskBasedFunds(p.risk).map(s=>`<span class="pill mf">${s}</span>`).join(" ")}</div>`;
      get('#plan_productShortlist').innerHTML = eqHtml + iap + riskEq + riskMf;

      let mfHtml = "";
      Object.keys(mfByCategory).forEach(cat=>{
        mfHtml += `<div style="margin-top:6px"><b class="mf">${cat}:</b> ${mfByCategory[cat].map(s=>`<span class="pill mf">${s}</span>`).join(" ")}</div>`;
      });
      get('#plan_mfShortlist').innerHTML = mfHtml;
    }

    /* Premium estimates */
    function renderPremiums(){
      const p = finalPlan.profile;
      const lifeCoverNeed = p.salary * 15;
      const lifeGap = Math.max(0, lifeCoverNeed - p.currentLife);
      let perCr = 8000;
      if(p.age>30 && p.age<=40) perCr = 12000;
      else if(p.age>40 && p.age<=50) perCr = 20000;
      else if(p.age>50) perCr = 35000;
      if(p.smoker==="yes") perCr *= 1.3;
      if(p.coverTerm > 30) perCr *= 1.1;
      const termSumAssuredCr = Math.ceil(lifeCoverNeed/1e7)/10; // crude Cr
      const estTermPremium = Math.round(perCr * termSumAssuredCr);

      let recommendedHealth = 300000 + (p.familySize*200000);
      if(p.parents === "yes") recommendedHealth += 500000;
      const healthGap = Math.max(0, recommendedHealth - p.currentHealth);
      const estHealthPremium = Math.round((recommendedHealth/100000) * 1500);

      get('#plan_premiumBox').innerHTML = `
        <div style="display:grid;grid-template-columns:1.4fr 1fr 1fr 1fr;gap:8px">
          <div><b>Term Life</b><div class="small">Need: ${fmtINR(lifeCoverNeed)}</div></div>
          <div>Gap: <b class="${lifeGap? 'bad':'ok'}">${fmtINR(lifeGap)}</b></div>
          <div>Sum Assured: <b>${termSumAssuredCr.toFixed(1)} Cr</b></div>
          <div>Est. Premium/mo: <b>${fmtINR(estTermPremium)}</b></div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1.4fr 1fr 1fr 1fr;gap:8px">
          <div><b>Health Insurance</b><div class="small">Recommended: ${fmtINR(recommendedHealth)}</div></div>
          <div>Gap: <b class="${healthGap? 'warn':'ok'}">${fmtINR(healthGap)}</b></div>
          <div>Cover After Topup: <b>${fmtINR(Math.max(p.currentHealth,recommendedHealth))}</b></div>
          <div>Est. Premium/yr: <b>${fmtINR(estHealthPremium)}</b></div>
        </div>
        <div class="note">Premiums are rough ballpark estimates. Adjusted for smoker, cover term & parents inclusion.</div>
      `;
    }

    function renderInsuranceShortlist(){
      const termPlans = ["HDFC Click 2 Protect","ICICI iProtect Smart","Max Life Smart Secure Plus","SBI Life eShield Next","Tata AIA Sampoorna Raksha Supreme"];
      const healthPlans = ["Star Health Family Health Optima","Niva Bupa ReAssure 2.0","HDFC Ergo Optima Restore","ICICI Lombard Health Protect","Care Health Advantage"];
      let html = `<div><b class="ins">Top 5 Term Plans:</b><br>${termPlans.map(s=>`<span class="pill ins">${s}</span>`).join(" ")}</div>`;
      html += `<div style="margin-top:10px"><b class="ins">Top 5 Health Plans:</b><br>${healthPlans.map(s=>`<span class="pill ins">${s}</span>`).join(" ")}</div>`;
      get('#plan_insuranceShortlist').innerHTML = html;
    }

    function renderGaps(){
      const p = finalPlan.profile;
      const neededEF = p.expenses * 6;
      const savedEF = p.expenses * p.emergencyMonths;
      const efGap = Math.max(0, neededEF - savedEF);
      const okBadge = `<span class="badge ok">OK</span>`;
      const warnBadge = `<span class="badge warn">Improve</span>`;
      const badBadge = `<span class="badge bad">High Gap</span>`;
      get('#plan_gaps').innerHTML = `
        <div style="display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr;gap:8px">
          <div><b>Emergency Fund</b><div class="small">Target 6 months</div></div>
          <div>Saved: <b>${fmtINR(savedEF)}</b></div>
          <div>Need: <b>${fmtINR(neededEF)}</b></div>
          <div>Status: ${efGap? (efGap>neededEF*0.5?badBadge:warnBadge):okBadge}</div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr;gap:8px">
          <div><b>Life Cover</b><div class="small">See premium estimates</div></div>
          <div>Existing: <b>${fmtINR(p.currentLife)}</b></div>
          <div>Recommended ~ <b>${fmtINR(Math.max(p.expenses*12*20, p.salary*10))}</b></div>
          <div>Status: ${(p.currentLife>=Math.max(p.expenses*12*20,p.salary*10))?okBadge:badBadge}</div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr;gap:8px">
          <div><b>Health Cover</b><div class="small">Family-based</div></div>
          <div>Existing: <b>${fmtINR(p.currentHealth)}</b></div>
          <div>Recommended ~ <b>${fmtINR(Math.max(600000, p.familySize*200000))}</b></div>
          <div>Status: ${(p.currentHealth>=Math.max(600000,p.familySize*200000))?okBadge:warnBadge}</div>
        </div>
      `;
    }

    function sipForGoal(target, years, annualReturnPct){
      const r = (annualReturnPct/100)/12;
      const n = Math.max(1, Math.round(years*12));
      const pmt = target * r / (Math.pow(1+r,n)-1);
      return Math.round(pmt);
    }

    function renderGoals(){
      const p = finalPlan.profile;
      const sipBudget = suggestedSipFromSalary(p);
      if(goals.length===0){
        get('#plan_goalsOutput').innerHTML = `<div class="note">Add goals to see suggested SIP per goal. Your current SIP budget (salary-based) is <b>${fmtINR(sipBudget)}/mo</b>.</div>`;
        return;
      }
      let html = `<div style="display:grid;grid-template-columns:1.2fr 1fr;gap:8px"><div><b>Goal</b></div><div><b>Suggested SIP / mo</b></div></div>`;
      let totalSIP = 0;
      goals.forEach(g=>{
        const sip = sipForGoal(g.target, g.years, g.returnPct);
        html += `<div style="display:grid;grid-template-columns:1.2fr 1fr;gap:8px;align-items:center"><div>${g.name}</div><div><b>${fmtINR(sip)}</b> <span class="hint">(${g.years}y @ ${g.returnPct}% p.a.)</span></div></div>`;
        totalSIP += sip;
      });
      const gap = Math.max(0, totalSIP - sipBudget);
      html += `<div class="divider"></div><div class="small" style="font-weight:800">Total SIP for goals: <span style="color:var(--primary)">${fmtINR(totalSIP)}/mo</span> â€¢ Salary-based SIP budget: <span style="color:var(--success)">${fmtINR(sipBudget)}/mo</span> ${gap>0 ? `â€¢ <span class="bad">Shortfall: ${fmtINR(gap)}/mo</span>` : `â€¢ <span class="ok">Within budget</span>`}</div>`;
      get('#plan_goalsOutput').innerHTML = html;
    }

    function renderGoldIdeas(){
      const ideas = [
        "Sovereign Gold Bonds (SGB): 8-year tenure with early exit windows; interest + potential price appreciation.",
        "Gold ETF + Debt Ladder: 5â€“10% of portfolio in liquid gold exposure via ETFs.",
        "Gold Savings via Monthly SIP: Align with festival purchases; hedge currency & inflation risk.",
        "Debt (MLD) sleeve for HNW: Post-tax efficient if eligible; size prudently."
      ];
      get('#plan_goldIdeas').innerHTML = ideas.map(i=>`<div>â€¢ ${i}</div>`).join("");
    }

    // asset pie chart
    function renderAssetChart(dist){
      const ctx = get('#plan_assetPie').getContext('2d');
      const labels = Object.keys(dist);
      const values = Object.values(dist).map(v=>Math.round(v*100));
      if(window._plan_assetChart) try{ window._plan_assetChart.destroy(); }catch(e){}
      window._plan_assetChart = new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:['#2f6bff','#10b981','#f59e0b','#a78bfa']}]},options:{plugins:{legend:{position:'bottom'}},cutout:'55%'}});
    }

    // export PDF (plan panel)
    async function exportPlanPDF(){
      if(!finalPlan){ alert('Generate plan first'); return; }
      const el = document.getElementById('plan_planPanel');
      const buttons = el.querySelectorAll('button'); buttons.forEach(b=>b.style.visibility='hidden');
      const canvas = await html2canvas(el, {scale:2.0, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("l","mm","a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 10;
      const imgW = pageW - margin*2;
      const imgH = (canvas.height * imgW) / canvas.width;
      if(imgH <= pageH - margin*2){
        pdf.addImage(imgData, "PNG", margin, margin, imgW, imgH);
      } else {
        const pxPerMm = canvas.width / imgW;
        let sY = 0;
        const canvasPageHeight = Math.round((pageH - margin*2) * (canvas.width / imgW));
        while(sY < canvas.height){
          const pageCanvas = document.createElement("canvas");
          pageCanvas.width = canvas.width;
          pageCanvas.height = Math.min(canvas.height - sY, canvasPageHeight);
          const ctx = pageCanvas.getContext("2d");
          ctx.drawImage(canvas, 0, sY, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);
          const pageImg = pageCanvas.toDataURL("image/png");
          if(sY > 0) pdf.addPage();
          const pageImgH = (pageCanvas.height * imgW) / canvas.width;
          pdf.addImage(pageImg, "PNG", margin, margin, imgW, pageImgH);
          sY += pageCanvas.height;
        }
      }
      pdf.save(`CORPIN_SmartPlan_${Date.now()}.pdf`);
      buttons.forEach(b=>b.style.visibility='visible');
    }

    // quick chat (simple rule-based)
    function suggestReply(q){
      const p = finalPlan ? finalPlan.profile : { age:35, salary:0, expenses:0, familySize:4, currentHealth:0, currentLife:0 };
      const lower = q.toLowerCase();
      const approxPremium = () => {
        const lifeCoverNeed = Math.max(p.expenses*12*20, p.salary*10);
        const basePerCr = 12000 * (p.age<=30?1:(p.age<=40?1.3:(p.age<=50?1.9:2.8)));
        const termSumAssuredCr = Math.ceil(lifeCoverNeed/1e7)/10;
        const estTermPremium = Math.round(basePerCr * termSumAssuredCr);
        const recommendedHealth = Math.max(600000, p.familySize*200000);
        const estHealthPremium = Math.round( (recommendedHealth/100000) * 1200 );
        return `Term (â‰ˆ${termSumAssuredCr.toFixed(1)} Cr): ~${fmtINR(estTermPremium)}/yr â€¢ Health (â‰ˆ${fmtINR(recommendedHealth)} cover): ~${fmtINR(estHealthPremium)}/yr`;
      };
      if(lower.includes("approx premium") || lower.includes("premium")) {
        return approxPremium() + ' â€¢ Tip: tweak salary/expenses/age and click Generate Plan for updated numbers.';
      }
      if(lower.includes("large") && lower.includes("fund")) return (mfByCategory["Large Cap"]||[]).slice(0,6).join(", ");
      if(lower.includes("mid") && lower.includes("fund")) return (mfByCategory["Mid Cap"]||[]).slice(0,6).join(", ");
      if(lower.includes("small") && lower.includes("fund")) return (mfByCategory["Small Cap"]||[]).slice(0,6).join(", ");
      if(lower.includes("top companies") || lower.startsWith("top")) {
        for(const key of Object.keys(sectorTopCompanies)){
          if(lower.includes(key)) return sectorTopCompanies[key].join(", ");
        }
        return "Try: Top companies in banking/it/fmcg/auto/pharma/energy/infra/telecom";
      }
      if(lower.includes("sip") && (lower.includes("salary") || lower.includes("budget"))) {
        const sip = suggestedSipFromSalary(p);
        return `Based on your salary & expenses, a practical SIP budget â‰ˆ ${fmtINR(sip)}/mo. Add goals to split this across targets.`;
      }
      if(lower.includes("equity allocation") || lower.includes("asset allocation")){
        return "Equity/ Debt/ Gold mix follows your risk profile. Use Conservative/Moderate/Aggressive to switch.";
      }
      if(lower.includes("gold")){
        return "Consider SGBs for long-term, Gold ETFs for liquidity. Keep gold 5â€“10% of total.";
      }
      return "Update inputs and click Generate Plan to refresh all sections. Try queries like: 'Approx premium', 'Large Cap funds', 'Top companies banking', 'SIP from salary'.";
    }

    // chat send
    function chatSend(){
      const q = (get('#plan_chatIn').value||"").trim();
      if(!q) return;
      const out = get('#plan_chatOut');
      const reply = suggestReply(q);
      out.innerHTML += `<div><b>You:</b> ${q}</div><div style="margin-bottom:8px"><b>Assistant:</b> ${reply}</div><div class="divider"></div>`;
      get('#plan_chatIn').value = '';
      out.scrollTop = out.scrollHeight;
    }
    get('#plan_chatBtn').addEventListener('click', chatSend);

    // quickbar initially
    renderQuickbar();

    // generateFinalPlan: core
    function generateFinalPlan(){
      const profile = {
        name: (get('#plan_name').value || "User"),
        dob: get('#plan_dob').value,
        age: Number(get('#plan_age').value)||computeAgeFromDOB(get('#plan_dob').value)||35,
        gender: get('#plan_gender').value,
        risk: get('#plan_risk').value,
        salary: Number(get('#plan_salary').value)||0,
        expenses: Number(get('#plan_expenses').value)||0,
        familySize: Number(get('#plan_familySize').value)||1,
        emergencyMonths: Number(get('#plan_emergencyMonths').value)||0,
        currentLife: Number(get('#plan_currentLife').value)||0,
        currentHealth: Number(get('#plan_currentHealth').value)||0,
        smoker: get('#plan_smoker').value || "no",
        coverTerm: Number(get('#plan_coverTerm').value) || 30,
        parents: get('#plan_parents').value || "no"
      };
      let alloc = { equity:0.5, debt:0.3, gold:0.1, realEstate:0.1 };
      if(profile.risk==="Conservative") alloc = { equity:0.35, debt:0.45, gold:0.15, realEstate:0.05 };
      if(profile.risk==="Aggressive")   alloc = { equity:0.65, debt:0.2, gold:0.1,  realEstate:0.05 };
      finalPlan = { profile, alloc };
      // Render all sections
      renderSummary(); renderKPI(); renderAssetChart(finalPlan.alloc); renderShortlists(); renderPremiums(); renderInsuranceShortlist(); renderGaps(); renderGoals(); renderGoldIdeas(); renderQuickbar();
      alert('Plan generated');
    }

    // export pdf button
    get('#plan_exportPdfBtn').addEventListener('click', exportPlanPDF);

    // initial baseline plan generation onload
    // generateFinalPlan(); // keep off so user can set inputs

  })(); // end SmartPlan IIFE
  </script>
</body>
</html>
